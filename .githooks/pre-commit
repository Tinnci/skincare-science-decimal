#!/bin/sh
# Typst Pre-commit Hook

# è·å–å·²æš‚å­˜ï¼ˆstagedï¼‰çš„ .typ æ–‡ä»¶
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.typ$')

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

echo "ğŸ” Validating Typst files..."
FAILED=0

for FILE in $STAGED_FILES; do
    # å°è¯•æ¨¡æ‹Ÿç¼–è¯‘ï¼Œæ˜¾å¼æŒ‡å®šè¾“å‡ºæ ¼å¼ä¸º pdf å¹¶é‡å®šå‘åˆ°ç©ºè®¾å¤‡
    if ! typst compile "$FILE" --pdf-standard 1.7 -f pdf - > /dev/null 2>&1; then
        echo "âŒ Syntax Error in: $FILE"
        # å†æ¬¡è¿è¡Œä»¥æ˜¾ç¤ºé”™è¯¯
        typst compile "$FILE" --pdf-standard 1.7 -f pdf -
        FAILED=1
    fi
done

if [ $FAILED -ne 0 ]; then
    echo "ğŸ›‘ Push blocked: Fix the Typst errors above and try again."
    exit 1
fi

echo "âœ… All Typst files passed."
exit 0
