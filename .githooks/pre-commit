#!/bin/sh
# Typst Pre-commit Hook

# è·å–å·²æš‚å­˜ï¼ˆstagedï¼‰çš„ .typ æ–‡ä»¶
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.typ$')

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

echo "ğŸ” Validating Typst files..."
FAILED=0

for FILE in $STAGED_FILES; do
    # å°è¯•æ¨¡æ‹Ÿç¼–è¯‘ï¼Œæ˜¾å¼æŒ‡å®šè¾“å‡ºæ ¼å¼ä¸º pdf å¹¶é‡å®šå‘åˆ°ç©ºè®¾å¤‡
    if ! typst compile "$FILE" --pdf-standard 1.7 -f pdf - --root . > /dev/null 2>&1; then
        echo "âŒ Syntax Error in: $FILE"
        # å†æ¬¡è¿è¡Œä»¥æ˜¾ç¤ºé”™è¯¯
        typst compile "$FILE" --pdf-standard 1.7 -f pdf - --root .
        FAILED=1
    fi
done

echo "ğŸ”„ Checking Bilingual Sync (Drift Detection)..."
for FILE in $STAGED_FILES; do
    # æ£€æŸ¥æ˜¯å¦ä¸ºä¸­è‹±æ–‡é…å¯¹æ–‡ä»¶
    PARTNER=""
    if [[ "$FILE" == *"_zh.typ" ]]; then
        PARTNER="${FILE%_zh.typ}.typ"
    elif [[ "$FILE" == *.typ ]]; then
        PARTNER="${FILE%.typ}_zh.typ"
    fi

    # å¦‚æœé…å¯¹æ–‡ä»¶å­˜åœ¨ä½†åœ¨æœ¬æ¬¡æäº¤ä¸­ç¼ºå¤±
    if [ -f "$PARTNER" ]; then
        if ! echo "$STAGED_FILES" | grep -q "$PARTNER"; then
            # æ¯”è¾ƒç£ç›˜ä¿®æ”¹æ—¶é—´ (ä»…ä½œå‚è€ƒï¼Œå› ä¸º Git ä¸å­˜æ—¶é—´)
            FILE_TIME=$(date -r "$FILE" +%s)
            PARTNER_TIME=$(date -r "$PARTNER" +%s)
            DIFF=$((FILE_TIME - PARTNER_TIME))
            ABS_DIFF=${DIFF#-} # å–ç»å¯¹å€¼

            # å¦‚æœæ—¶é—´å·®è¶…è¿‡ 3600 ç§’ (1å°æ—¶)
            if [ $ABS_DIFF -gt 3600 ]; then
                echo "âš ï¸  [Warning] Bilingual Drift detected: $FILE was updated, but $PARTNER seems stale (diff > 1h)."
                echo "   If this is intentional, you can bypass with 'git commit --no-verify'."
                # è®¾ç½®ä¸ºè­¦å‘Šè€Œéå¼ºåˆ¶æŠ¥é”™ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦æ”¹ä¸º exit 1
            fi
        fi
    fi
done

if [ $FAILED -ne 0 ]; then
    echo "ğŸ›‘ Commit blocked: Fix the Typst errors above and try again."
    exit 1
fi

echo "âœ… All Typst files passed."
exit 0
